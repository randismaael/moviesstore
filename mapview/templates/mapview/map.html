{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-3">
  <div class="row">
    <!-- Map Section -->
    <div class="col-md-8">
      <div id="map" style="height: 600px; border-radius: 10px;"></div>
    </div>

    <!-- Sidebar Section -->
    <div class="col-md-4">
      <div class="card shadow p-3">
        <h4 class="text-center">Top 3 Movies in <span id="region-name">Select a Region</span></h4>
        <ul id="movie-list" class="list-group mt-3">
          <li class="list-group-item text-muted">Click on a region marker to view trending movies.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Include Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const map = L.map("map").setView([35.6895, 139.6917], 4); // Center on Japan

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "© OpenStreetMap"
  }).addTo(map);

  fetch("{% url 'mapview:local_popularity_data' %}")
    .then(response => response.json())
    .then(data => {
      for (const [region, movies] of Object.entries(data)) {
        if (region === "Unknown") continue; // skip unknowns

        // Use a simple geocoder (free API) to get coordinates dynamically
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(region)}`)
          .then(r => r.json())
          .then(results => {
            if (!results[0]) return;
            const lat = results[0].lat;
            const lon = results[0].lon;

            const marker = L.marker([lat, lon]).addTo(map);
            marker.bindPopup(`<b>${region}</b><br>Click to view top movies.`);

            marker.on("click", () => {
              document.getElementById("region-name").textContent = region;
              const movieList = document.getElementById("movie-list");
              movieList.innerHTML = "";

              // Show top 3 movies
              movies.slice(0, 3).forEach(m => {
                const li = document.createElement("li");
                li.classList.add("list-group-item");
                li.innerHTML = `<b>${m.movie}</b> — ${m.count} orders`;
                movieList.appendChild(li);
              });
            });
          });
      }
    })
    .catch(err => console.error(err));
});
</script>
{% endblock %}